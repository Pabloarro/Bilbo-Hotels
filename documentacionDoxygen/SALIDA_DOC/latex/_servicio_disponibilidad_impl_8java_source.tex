\doxysection{Servicio\+Disponibilidad\+Impl.\+java}
\hypertarget{_servicio_disponibilidad_impl_8java_source}{}\label{_servicio_disponibilidad_impl_8java_source}\index{C:/Users/pabloA/Bilbo-\/Hotels/src/main/java/es/deusto/bilboHotels/service/impl/ServicioDisponibilidadImpl.java@{C:/Users/pabloA/Bilbo-\/Hotels/src/main/java/es/deusto/bilboHotels/service/impl/ServicioDisponibilidadImpl.java}}
\mbox{\hyperlink{_servicio_disponibilidad_impl_8java}{Ir a la documentación de este archivo.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00001}00001\ \textcolor{keyword}{package\ }es.deusto.bilboHotels.service.impl;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00002}00002\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00003}00003\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.model.Disponibilidad;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00004}00004\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.model.Hotel;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00005}00005\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.model.Habitacion;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00006}00006\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.model.dto.HabitacionSeleccionDTO;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00007}00007\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.model.enums.TipoHabitacion;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00008}00008\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.repository.RepoDisponibilidad;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00009}00009\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.service.ServicioDisponibilidad;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00010}00010\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.service.ServicioHotel;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00011}00011\ \textcolor{keyword}{import}\ es.deusto.bilboHotels.service.ServicioHabitacion;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00012}00012\ \textcolor{keyword}{import}\ jakarta.persistence.EntityNotFoundException;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00013}00013\ \textcolor{keyword}{import}\ lombok.RequiredArgsConstructor;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00014}00014\ \textcolor{keyword}{import}\ lombok.extern.slf4j.Slf4j;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00015}00015\ \textcolor{keyword}{import}\ org.springframework.stereotype.Service;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00016}00016\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00017}00017\ \textcolor{keyword}{import}\ java.time.LocalDate;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00018}00018\ \textcolor{keyword}{import}\ java.util.List;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00019}00019\ \textcolor{keyword}{import}\ java.util.stream.Collectors;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00020}00020\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00021}00021\ @Service}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00022}00022\ @RequiredArgsConstructor}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00023}00023\ @Slf4j}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00024}\mbox{\hyperlink{classes_1_1deusto_1_1bilbo_hotels_1_1service_1_1impl_1_1_servicio_disponibilidad_impl}{00024}}\ \textcolor{keyword}{public}\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classes_1_1deusto_1_1bilbo_hotels_1_1service_1_1impl_1_1_servicio_disponibilidad_impl}{ServicioDisponibilidadImpl}}\ \textcolor{keyword}{implements}\ ServicioDisponibilidad\ \{}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00025}00025\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00026}00026\ \ \ \ \ \textcolor{keyword}{private}\ \textcolor{keyword}{final}\ RepoDisponibilidad\ repoDisponibilidad;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00027}00027\ \ \ \ \ \textcolor{keyword}{private}\ \textcolor{keyword}{final}\ ServicioHotel\ servicioHotel;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00028}00028\ \ \ \ \ \textcolor{keyword}{private}\ \textcolor{keyword}{final}\ ServicioHabitacion\ servicioHabitacion;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00029}00029\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00030}00030\ \ \ \ \ @Override}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00031}\mbox{\hyperlink{classes_1_1deusto_1_1bilbo_hotels_1_1service_1_1impl_1_1_servicio_disponibilidad_impl_a9b4f66af41aa1609d7416d772700fc90}{00031}}\ \ \ \ \ \textcolor{keyword}{public}\ Integer\ \mbox{\hyperlink{classes_1_1deusto_1_1bilbo_hotels_1_1service_1_1impl_1_1_servicio_disponibilidad_impl_a9b4f66af41aa1609d7416d772700fc90}{getMininimoHabitacionesDisponibles}}(Long\ habitacionId,\ LocalDate\ fechaCheckIn,\ LocalDate\ fechaCheckOut)\ \{}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00032}00032\ \ \ \ \ \ \ \ \ log.info(\textcolor{stringliteral}{"{}Recuperando\ la\ cantidad\ mínima\ de\ habitaciones\ disponibles\ para\ el\ ID\ de\ habitación\ \{\}\ desde\ \{\}\ hasta\ \{\}"{}},\ habitacionId,\ fechaCheckIn,\ fechaCheckOut);}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00033}00033\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00034}00034\ \ \ \ \ \ \ \ \ Habitacion\ habitacion\ =\ servicioHabitacion.buscarHabitacionbyId(habitacionId).orElseThrow(()\ -\/>\ \textcolor{keyword}{new}\ EntityNotFoundException(\textcolor{stringliteral}{"{}Habitacion\ no\ encontrada"{}}));}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00035}00035\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00036}00036\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Fetch\ the\ minimum\ available\ rooms\ throughout\ the\ booking\ range\ for\ a\ room\ ID.}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00037}00037\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ repoDisponibilidad.getMinAvailableRooms(habitacionId,\ fechaCheckIn,\ fechaCheckOut)}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00038}00038\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .orElse(habitacion.getContadorHabitacion());\ \textcolor{comment}{//\ Consider\ no\ record\ as\ full\ availability}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00039}00039\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00040}00040\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00041}00041\ \ \ \ \ @Override}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00042}\mbox{\hyperlink{classes_1_1deusto_1_1bilbo_hotels_1_1service_1_1impl_1_1_servicio_disponibilidad_impl_a66e1d4a702570ed24057203d43aaef92}{00042}}\ \ \ \ \ \textcolor{keyword}{public}\ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classes_1_1deusto_1_1bilbo_hotels_1_1service_1_1impl_1_1_servicio_disponibilidad_impl_a66e1d4a702570ed24057203d43aaef92}{actualizarDisponibilidades}}(\textcolor{keywordtype}{long}\ hotelId,\ LocalDate\ fechaCheckIn,\ LocalDate\ fechaCheckOut,\ List<HabitacionSeleccionDTO>\ seleccionHabitaciones)\ \{}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00043}00043\ \ \ \ \ \ \ \ \ Hotel\ hotel\ =\ servicioHotel.buscarHotelById(hotelId).orElseThrow(()\ -\/>\ \textcolor{keyword}{new}\ EntityNotFoundException(\textcolor{stringliteral}{"{}Hotel\ no\ encontrado"{}}));}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00044}00044\ \ \ \ \ \ \ \ \ log.info(\textcolor{stringliteral}{"{}Intentando\ actualizar\ las\ disponibilidades\ para\ el\ ID\ del\ hotel\ \{\}\ desde\ \{\}\ hasta\ \{\}"{}},\ hotelId,\ fechaCheckIn,\ fechaCheckOut);}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00045}00045\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00046}00046\ \ \ \ \ \ \ \ \ seleccionHabitaciones\ =\ seleccionHabitaciones.stream()}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00047}00047\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .filter(seleccionHabitacion\ -\/>\ seleccionHabitacion.getContar()\ >\ 0)}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00048}00048\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .collect(Collectors.toList());}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00049}00049\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00050}00050\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Iterate\ through\ the\ room\ selections\ made\ by\ the\ user}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00051}00051\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (HabitacionSeleccionDTO\ seleccionHabitacion\ :\ seleccionHabitaciones)\ \{}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00052}00052\ \ \ \ \ \ \ \ \ \ \ \ \ TipoHabitacion\ tipoHabitacion\ =\ seleccionHabitacion.getTipoHabitacion();}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00053}00053\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ selectedCount\ =\ seleccionHabitacion.getContar();}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00054}00054\ \ \ \ \ \ \ \ \ \ \ \ \ log.debug(\textcolor{stringliteral}{"{}Procesando\ \{\}\ habitación(es)\ de\ tipo\ \{\}"{}},\ selectedCount,\ tipoHabitacion);}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00055}00055\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00056}00056\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Find\ the\ room\ by\ roomType\ for\ the\ given\ hotel}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00057}00057\ \ \ \ \ \ \ \ \ \ \ \ \ Habitacion\ room\ =\ hotel.getHabitaciones().stream()}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00058}00058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .filter(r\ -\/>\ r.getTipoHabitacion()\ ==\ tipoHabitacion)}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00059}00059\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .findFirst()}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00060}00060\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .orElseThrow(()\ -\/>\ \textcolor{keyword}{new}\ EntityNotFoundException(\textcolor{stringliteral}{"{}Tipo\ habitacion\ no\ encontrada"{}}));}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00061}00061\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00062}00062\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Iterate\ through\ the\ dates\ and\ update\ or\ create\ availability}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00063}00063\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (LocalDate\ fecha\ =\ fechaCheckIn;\ fecha.isBefore(fechaCheckOut);\ fecha\ =\ fecha.plusDays(1))\ \{}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00064}00064\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{final}\ LocalDate\ fechaActual\ =\ fecha;\ \textcolor{comment}{//\ Temporary\ final\ variable}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00065}00065\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Disponibilidad\ disponibilidad\ =\ repoDisponibilidad.findByHabitacionIdAndFecha(room.getId(),\ fecha)}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00066}00066\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .orElseGet(()\ -\/>\ Disponibilidad.builder()}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00067}00067\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .hotel(hotel)}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00068}00068\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .fecha(fechaActual)}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00069}00069\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .habitacion(room)}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00070}00070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .habitacionesDisponibles(room.getContadorHabitacion())}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00071}00071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ .build());}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00072}00072\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00073}00073\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Reduce\ the\ available\ rooms\ by\ the\ selected\ count}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00074}00074\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ actualizadasHabitacionesDisponibles\ =\ disponibilidad.getHabitacionesDisponibles()\ -\/\ selectedCount;}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00075}00075\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (actualizadasHabitacionesDisponibles\ <\ 0)\ \{}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00076}00076\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{throw}\ \textcolor{keyword}{new}\ IllegalArgumentException(\textcolor{stringliteral}{"{}Las\ habitaciones\ seleccionadas\ superan\ las\ habitaciones\ disponibles\ para\ la\ fecha:\ "{}}\ +\ fechaActual);}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00077}00077\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00078}00078\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ disponibilidad.setHabitacionesDisponibles(actualizadasHabitacionesDisponibles);}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00079}00079\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00080}00080\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ repoDisponibilidad.save(disponibilidad);}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00081}00081\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00082}00082\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00083}00083\ \ \ \ \ \ \ \ \ log.info(\textcolor{stringliteral}{"{}Se\ han\ actualizado\ las\ disponibilidades\ correctamente\ para\ el\ ID\ del\ hotel\ \{\}\ desde\ \{\}\ hasta\ \{\}"{}},\ hotelId,\ fechaCheckIn,\ fechaCheckOut);}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00084}00084\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00085}00085\ }
\DoxyCodeLine{\Hypertarget{_servicio_disponibilidad_impl_8java_source_l00086}00086\ \}}

\end{DoxyCode}
